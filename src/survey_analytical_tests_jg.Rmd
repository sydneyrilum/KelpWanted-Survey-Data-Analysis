---
title: "statsistical_tests_jg"
author: "Janelle Gaun"
date: "1/30/2022"
output: html_document
---

```{r setup, include=FALSE, warning= FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(janitor)
library(data.table)  # advanced pivot_table tools
library(naniar)      # replace NA tools
#library(sf)          # read in shapefiles
#library(tmap)        # interactive maps
#library(zipcodeR)    # for zipcode assignment by county
#library(raster)      # for mapping raster layers
#library(dplyr)       # needed ONLY if working on a windows computer
#library(ggwordcloud) # create wordcloud plots
library(patchwork)   # for stacking plots
library(kableExtra)  # for making tables
library(broom)
library(MASS)         #for ordered logist or probit regression
library(conflicted)  # allows for choosing preference over conflicting functions from different packages
library(RColorBrewer)
library(reshape)
library(lattice)
conflict_prefer("select", "dplyr")# use select function from tidyverse/dplyr package > from raster package
conflict_prefer("filter", "dplyr")
conflict_prefer("chisq.test", "janitor")
conflict_prefer("fisher.test", "janitor")
conflict_prefer("melt", "reshape")
```

```{r load data}
#load in compiled data files 

survey_data_tidy_sbv_filtered <- read.csv(here("data", "survey_data_tidy_sbv_filtered.csv")) %>% 
  filter(response_type != 3)

survey_data_tidy_sbv_long_filtered <- read.csv(here("data", "survey_data_tidy_sbv_long_filtered.csv")) %>% 
 filter(response_type != 3)
```

## Familiarity

We test the relationship between people's familiarity with aquaculture and their perceptions of seaweed aquaculture using a chi-squared test. 

*10 & 13. perception and Familiarity* 

*Question:* Does familiarity with aquaculture influence their  of aquaculture? 

*Null Hypothesis (H0):*  There is no association between the two variables (familiarity and perceptions) i.e. they are independent 

*Statistical Test:* Chi-square test of Q10 & Q13

*Test Statistic:* P-value > 0.05 


#### Q10 (familiarity) v. Q13 (perception of seaweed aq)
```{r 10v.13 dataframe, table and plot}
#create subset from tidy filtered data
#keep only question 10 and 13
k_p <- survey_data_tidy_sbv_long_filtered %>% 
  select(response_id, question, answer, weight) %>% 
  filter(question == "q10"|
           question == "q13") %>% 
#switch to wide format with response id as the link
 spread(question, answer) %>% 
  mutate(q13 = fct_relevel(q13, c(c("Very Negative", "Negative","Neutral","Positive", "Very Positive", "Unsure/Not familiar")))) %>% 
  mutate(q10 = fct_relevel(q10, c(c("Very familiar", "Basic understanding", "Heard of it, but don't know details", "Never heard of it")))) 

ggplot(k_p, aes(fill= q13, x = q10))+
  geom_bar(position = "dodge")+
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#D7191C", "#FDAE61", "#FFFFBF", "#ABD9E9","#2C7BB6", "#999999")) +
  labs(y = "count",
       x = "Familiarity with Aquaculture")+
  theme(legend.title = element_text("Perception of Seaweed Aquaculture")) +
  theme_minimal()
  
#put counts into table format
k_p_table<- k_p %>% 
  tabyl(q10, q13) 
```

```{r 10v.13 dataframe, table and plot WEIGHTED}
#create subset from tidy filtered data
#keep only question 10 and 13
k_p_weighted <- survey_data_tidy_sbv_long_filtered %>% 
  select(response_id, question, answer, weight) %>% 
  filter(question == "q10"|
           question == "q13") %>% 
#switch to wide format with response id as the link
  spread(question, answer) %>% 
    mutate(q13 = fct_relevel(q13, c(c("Very Negative", "Negative","Neutral","Positive", "Very Positive", "Unsure/Not familiar")))) %>% 
  mutate(q10 = fct_relevel(q10, c(c("Very familiar", "Basic understanding", "Heard of it, but don't know details", "Never heard of it")))) %>%  
  group_by(q13, q10) %>% 
  summarize(weight_count = sum(weight)) %>% 
  ungroup() %>% 
  group_by(q10) %>% 
  mutate(proportion = (weight_count/sum(weight_count)))

##CHECK THESE RESULTS
ggplot(k_p_weighted, aes(x = q10, y = weight_count))+
  geom_bar(position = "dodge")+
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#D7191C", "#FDAE61", "#FFFFBF", "#ABD9E9","#2C7BB6", "#999999")) +
  labs(y = "count",
       x = "Familiarity with Aquaculture")+
  theme(legend.title = element_text("Perception of Seaweed Aquaculture")) +
  theme_minimal()

#put counts into table format
k_p_table_weighted<- k_p_weighted %>% 
  tabyl(q10, q13) 
```

One key assumption of the chi-square test is that 80% of the cells must have an expected value of 5 or greater. Only 14 of the 24 cells meet this requirement (58%), therefore violating the assumptions of the chi-square test. We will use the maximum liklihood chi-square test to also understand the relationship bewteen the two variables. 


```{r 10 v. 13 chi squared test}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `q10` column entries into stored rownames)
k_p_ct <- k_p_table %>% 
  column_to_rownames(var = "q10")

# Chi-square test for independence: Is there an association between support for aquaculture and word choice?
knowledge_perception_x2 <- chisq.test(k_p_ct)
knowledge_perception_x2

# Get the chi-square test results to call outputs in-line
k_p_x2_tidy <- tidy(knowledge_perception_x2)
```

The p-squared value `r round(k_p_x2_tidy[1, 2], 2)` is less than alpha (0.05) indicating the null hypothesis- that the two variables are independent- failed. However, there were some counts that were less than 5 which indicates there should be additional study. However, the data violates an assumption of the chi-square test so we conduct the maximum likelihood test below. 

We will aggregate 'very negative' and 'negative' and 'very positive' and 'postiive' and run the chi-square with these groups. 

```{r group Q13 responses}
#create subset from tidy filtered data
#keep only question 10 and 13
k_p_grouped <- survey_data_tidy_sbv_long_filtered %>% 
  select(response_id, question, answer) %>% 
  filter(question == "q10"|
           question == "q13") %>% 
#switch to wide format with response id as the link
 spread(question, answer) %>% 
#group responses
    mutate(q13= case_when(
    q13 == "Very Negative" ~ "Negative",
    q13 == "Negative" ~ "Negative",
    q13 =="Neutral" ~ "Neutral",
    q13 == "Positive" ~ "Positive",
    q13 =="Very Positive" ~ "Positive",
    q13 =="Unsure/Not familiar" ~ "Unsure/Not familiar",
  ))

#ggplot(k_p, aes(fill= q13, x = q10))+
 # geom_bar(position = "dodge")+
  #scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  #scale_fill_manual(values =c("#D7191C", "#FDAE61", "#FFFFBF", "#ABD9E9","#2C7BB6", "#999999"))
  
#put counts into table format
k_p_grouped_table<- k_p_grouped %>% 
  tabyl(q10, q13) 
```

```{r Q13 grouped chi-squared}
k_p_grouped_ct <- k_p_grouped_table%>% 
  column_to_rownames(var = "q10")

# Chi-square test for independence: Is there an association between support for aquaculture and word choice?
knowledge_perception_grouped_x2 <- chisq.test(k_p_grouped_ct)
knowledge_perception_grouped_x2

```

When perception is combined into 'negative', 'neutral', 'positive', and 'unsure', the null hypothesis is rejected (p-value= 2.22 x10-7, alpha =0.05) which indicates the variables are dependent. 

We can also use the Fisher's exact test to calculate the exact p-value. **Fisher's test requires a high number of simulations because the value of p is so small. Kept crashing R**

```{r 10 v. 13 Fischer's exact test}
#fisher.test(k_p_ct, workspace = 2e7)
```

#### Q16 (heard about aq) v. Q13 (perception)

```{r dataset Q16(heard of aq) v Q13 }
#create subset from tidy filtered data
#keep only question 16 and 13
k_p_heard <- survey_data_tidy_sbv_long_filtered %>% 
  select(response_id, question, answer) %>% 
  filter(question == "q16"|
           question == "q13") %>% 
#switch to wide format with response id as the link
 spread(question, answer) %>% 
  #group responses
  mutate(q13= case_when(
    q13 == "Very Negative" ~ "Negative",
    q13 == "Negative" ~ "Negative",
    q13 =="Neutral" ~ "Neutral",
    q13 == "Positive" ~ "Positive",
    q13 =="Very Positive" ~ "Positive",
    q13 =="Unsure/Not familiar" ~ "Unsure/Not familiar",
  ))

ggplot(k_p_heard, aes(fill= q13, x = q16))+
  geom_bar(position = "dodge")+
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#D7191C", "#FFFFBF", "#2C7BB6", "#999999"))
  
#put counts into table format
k_p_heard_table<- k_p_heard %>% 
  tabyl(q16, q13) 
```

```{r 16 v. 13 chi squared test}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `q10` column entries into stored rownames)
k_p_heard_ct <- k_p_heard_table %>% 
  column_to_rownames(var = "q16")

# Chi-square test for independence: Is there an association between support for aquaculture and word choice?
k_p_heard_x2 <- chisq.test(k_p_heard_ct)
k_p_heard_x2

# Get the chi-square test results to call outputs in-line
k_p_x2_tidy <- tidy(k_p_heard_x2)
```

The data violate the assumptions of the chi-square test (80% of the expected values >5). The fisher exact test will be used instead. 

```{r 16 v. 13 fisher test}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `q10` column entries into stored rownames)

fisher_Q16 <- fisher.test(k_p_heard_ct)
fisher_Q16 <- tidy(fisher_Q16)
```

The null hypothesis was rejected using the Fisher exact test (p-value = 3..7x10-7, alpha =0.05). There is a relationship between hearning about aquaculture perceptions of aquaculture.

#### Q17 (seen aq) v. Q13 (perception)

```{r dataset Q16(heard of aq) v Q13- grouped}
#create subset from tidy filtered data
#keep only question 16 and 13
k_p_seen <- survey_data_tidy_sbv_long_filtered %>% 
  filter(response_type != 3) %>% 
  select(response_id, question, answer) %>% 
  filter(question == "q17"|
           question == "q13") %>% 
#switch to wide format with response id as the link
 spread(question, answer) %>% 
  #group responses
  mutate(q13= case_when(
    q13 == "Very Negative" ~ "Negative",
    q13 == "Negative" ~ "Negative",
    q13 =="Neutral" ~ "Neutral",
    q13 == "Positive" ~ "Positive",
    q13 =="Very Positive" ~ "Positive",
    q13 =="Unsure/Not familiar" ~ "Unsure/Not familiar",
  ))

ggplot(k_p_seen, aes(fill= q13, x = q17))+
  geom_bar(position = "dodge")+
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#D7191C", "#FFFFBF", "#2C7BB6", "#999999"))
  
#put counts into table format
k_p_seen_table<- k_p_seen %>% 
  tabyl(q17, q13) 
```

The data did not meet the assumptions of the chi-sqare test(80% of expected values >5). Data was tested using the Fisher exact test instead. 

```{r 17 v. 13 fishertest}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `q10` column entries into stored rownames)
k_p_seen_ct <- k_p_seen_table %>% 
  column_to_rownames(var = "q17")

fisher_Q17 <- fisher.test(k_p_seen_ct)
fisher_Q17 <- tidy(fisher_Q17)
```


The Fisher exact test rejected the null hypothesis- that the two variables are independent (p-vale= 0.031, alpha =0.05). 


#### Age v. Perception

In this section we will compare age with perception

```{r}
age_perception <- survey_data_tidy_sbv_filtered %>% 
  select(q41,q40, q39, q38, q37, q36, q35, q34, q33, q32, q31) 

dems$q31 <- as.integer(dems$q31)
```



## Regression Models 

####Relationship Between perception and support

*Question:* Is support related to more postie perception of seaweed aquaculture?

*Hypothesis:* Those who view seaweed aquaculture more positively will be more likely to be in support of seaweed aquaculture expansion.

*Assumptions:* 
- Since Q2,4, 6, 8 are not significantly different, then questions/answers can thus be combined.
- Remove "don't know" answer choice counts

*Statistical Test:* Ordinal logistic regression of perception combined support values (Q2,4,6,8) vs. perception of seaweed aquaculture (Q13)

dependent variable = support (Q2)
independent variable = perception (Q13)


```{r regression table }
# create data frame with Q2 and Q13 

ordinal_log_reg_knowledge_data <- survey_data_tidy_sbv_long_filtered %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8" |
         question == "q13") %>%
  mutate(question = case_when( 
    question == "q2" ~ "q2",
    question == "q4" ~ "q2",
    question == "q6" ~ "q2",
    question == "q8" ~ "q2",
    question == "q13" ~ "q13")) %>% 
  mutate(answer = case_when( 
    answer == "Strongly opposed" ~ -2,
    answer == "Somewhat opposed" ~ -1,
    answer == "Neither opposed nor in support" ~ 0,
    answer == "Somewhat supportive" ~ 1,
    answer == "Strongly supportive" ~ 2,
    answer == "Very Positive" ~ 2,
    answer == "Positive" ~ 1,
    answer == "Neutral" ~ 0,
    answer == "Negative" ~ -1,
    answer == "Very NegativeNegative" ~ -2,
    answer == "Unsure/Not familiar" ~ -999)) %>%
  replace_with_na(replace = list(answer = -999))%>% 
  filter(answer != "NA") # remove incomplete responses

```

```{r}
# use spread() to pivot table to wide format
ordinal_log_reg_knowledge <- ordinal_log_reg_knowledge_data %>% 
  select(response_id, question, answer) %>% 
  spread(question, answer) %>% 
  filter(q13 != "NA")  %>% # remove incomplete responses
  filter(q2 != "NA") # remove incomplete responses
  
ordinal_log_reg_knowledge_table<- ordinal_log_reg_knowledge %>% 
  tabyl(q2, q13) %>% 
  column_to_rownames(var = "q2")

summary(ordinal_log_reg_knowledge_table)

```


```{r create ordinal logistic model}
#use polr to create a logit model to understand how familiarity influences expansion
m2 <- polr(factor(q2) ~q13, data=ordinal_log_reg_knowledge, Hess =TRUE)
summary(m2)
```

the q13 coefficient value represents the eta so as eta gets bigger then zeta gets smaller. 

Intercepts are the zeta values. 

```{r understand odds ratio}
#interpret odds ratio to probabilities. Outside parenthesis are important 
(ci <- confint(m2))
exp(cbind(coef(m2), t(ci)))
```


```{r predicted probabilities to understand odds ratio}
newdf_2 <- data.frame(q13 =c(1, 2, 3, 4, 5))
(phat1 <- predict(object = m2, newdf_2, type = "p"))

coul <- colorRampPalette(brewer.pal(8, "Blues"))(25)
levelplot(phat1, col.regions= coul,
          xlab = "perception",
          ylab = "support",
          main = "Predicted Probabilities")
```




####Relationship Between Familiarity and Support: 


*Question:* Does familiarity with seaweed aquaculture depend on whether or not one is in support of aquaculture?

*Hypothesis:* Yes, supporters will be more familiar with seaweed aquaculture.

*Assumptions:* 
- Since Q2,4, 6, 8 are not significantly different, then questions/answers can thus be combined.
- Remove "don't know" answer choice counts

*Statistical Test:* Ordinal logistic regression of perception combined support values (Q2,4,6,8) vs. perception value from Q13 (seaweed aquaculture)


dependent variable = support (Q2)
independent variable = familiarity (Q10)


```{r regression table }
# create data frame with Q2 and Q10

ordinal_log_reg_2_data <- survey_data_tidy_sbv_long_filtered %>% 
  filter(response_type != 3) %>% #filter out self-collected data
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8" |
         question == "q10") %>%
  mutate(question = case_when( 
    question == "q2" ~ "q2",
    question == "q4" ~ "q2",
    question == "q6" ~ "q2",
    question == "q8" ~ "q2",
    question == "q10" ~ "q10")) %>% 
  mutate(answer = case_when( 
    answer == "Strongly opposed" ~ -2,
    answer == "Somewhat opposed" ~ -1,
    answer == "Neither opposed nor in support" ~ 0,
    answer == "Somewhat supportive" ~ 1,
    answer == "Strongly supportive" ~ 2,
    answer == "Very familiar" ~ 1,
    answer == "Basic understanding" ~ 2,
    answer == "Heard of it, but don't know details" ~ 3,
    answer == "Never heard of it" ~ 4)) %>%
  filter(answer != "NA") # remove incomplete responses

```

```{r}
# use spread() to pivot table to wide format
ordinal_log_reg_2 <- ordinal_log_reg_2_data %>% 
  select(response_id, question, answer) %>% 
  spread(question, answer) %>% 
  filter(q10 != "NA")  %>% # remove incomplete responses
  filter(q2 != "NA") # remove incomplete responses
  
ordinal_log_reg_2_table<- ordinal_log_reg_2 %>% 
  tabyl(q2, q10) %>% 
  column_to_rownames(var = "q2")

summary(ordinal_log_reg_2_table)

```


```{r create ordinal logistic model}
#use polr to create a logit model to understand how familiarity influences expansion
m1 <- polr(factor(q2) ~q10, data=ordinal_log_reg_2, Hess =TRUE)
summary(m1)
```

The output shows that for respondents who very familiar with aquaculture, the log odds of being unlikely to support aquaculture is 0.9079 points lower than respondents who are not familiar with aquaculture.




```{r understand odds ratio}
#interpret odds ratio. Outside parenthesis are important 
(ci <- confint(m1))
exp(cbind(coef(m1), t(ci)))
```


```{r predicted probabilities to understand odds ratio}
newdf <- data.frame(q10 =c(1, 2, 3, 4))
(phat <- predict(object = m1, newdf, type = "p"))

#coul is the color palette
coul <- colorRampPalette(brewer.pal(8, "Blues"))(100)

#heatmap
levelplot(phat, col.regions= coul,
          xlab = "familiarity",
          ylab = "support",
          main = "Predicted Probabilities")
```

From Casey O'Hara: cool data visualization could be probability of support on the x axis and knowledge on the y axis to show the relative 

You can runt hese combined. Do a chi-squared on knowledge and perception to understand the relationship among the two 


####Relationship Between Perception and Familiarity: 

*Question:* Is perception related to familiarity with seaweed aquaculture?

*Hypothesis:* 

*Assumptions:* 
- Remove "don't know" answer choice counts

*Statistical Test:* Ordinal logistic regression of 


dependent variable = perception (q13)
independent variable = familiarity (Q10)


```{r regression table }
# create data frame with Q10 and Q13

ordinal_log_reg_3_data <- survey_data_tidy_sbv_long_filtered %>% 
  filter(response_type != 3) %>% #filter out self-collected data
  filter(question == "q10" | 
         question == "q13") %>%
  mutate(answer = case_when( 
    answer == "Very familiar" ~ 4,
    answer == "Basic understanding" ~ 3,
    answer == "Heard of it, but don't know details" ~ 2,
    answer == "Never heard of it" ~ 1,
    answer == "Very Positive" ~ 2,
    answer == "Positive" ~ 1,
    answer == "Neutral" ~ 0,
    answer == "Negative" ~ -1,
    answer == "Very Negative" ~ -2,
    answer == "Unsure/Not familiar" ~ -999)) %>%
  replace_with_na(replace = list(answer = -999))%>% 
  filter(answer != "NA") # remove incomplete responses

```

```{r}
# use spread() to pivot table to wide format
ordinal_log_reg_3 <- ordinal_log_reg_3_data %>% 
  select(response_id, question, answer) %>% 
  spread(question, answer) %>% 
  filter(q10 != "NA")  %>% # remove incomplete responses
  filter(q13 != "NA") # remove incomplete responses
  
ordinal_log_reg_3_table<- ordinal_log_reg_3 %>% 
  tabyl(q13, q10) %>% 
  column_to_rownames(var = "q13")

summary(ordinal_log_reg_3_table)

```

```{r create ordinal logistic model}
#use polr to create a logit model to understand how familiarity influences expansion
m3 <- polr(factor(q13) ~q10, data=ordinal_log_reg_3, Hess =TRUE)
summary(m3)
```

```{r understand odds ratio}
#interpret odds ratio. Outside parenthesis are important 
(ci3 <- confint(m3))
exp(cbind(coef(m3), t(ci3)))
```

```{r predicted probabilities to understand odds ratio}
newdf3 <- data.frame(q10 =c(1, 2, 3, 4))
(phat3 <- predict(object = m3, newdf3, type = "p"))

#coul is the color palette
coul <- colorRampPalette(brewer.pal(8, "Blues"))(100)

#heatmap
levelplot(phat3, col.regions= coul,
          xlab = "familiarity",
          ylab = "perception",
          main = "Predicted Probabilities") 
```


####Relationship Between Support and Perception & Familiarity: 

*Question:* Is support related to level of familiarity with and perception of seaweed aquaculture?

*Hypothesis:* 

*Assumptions:* 
- Remove "don't know" answer choice counts

*Statistical Test:* Ordinal logistic regression of 


dependent variable = support (Q2)
independent variables = perception (Q13) & age group(calculated)


```{r regression table age group & perception v. support }
# create data frame with age_group and Q13
ordinal_log_reg_4_data <- age %>% 
  filter(response_type != 3) %>% #filter out self-collected data
  select (age_group, q13, q2,q4, q6, q8) %>%
  unite("support", q2:q8, sep = "") %>% 
  mutate(support = case_when(
    support == "Strongly opposed" ~ -2,
    support == "Somewhat opposed" ~ -1,
    support == "Neither opposed nor in support" ~ 0,
    support == "Somewhat supportive" ~ 1,
    support == "Strongly supportive" ~ 2)) %>% 
  mutate(q13 = case_when(
    q13 == "Very Positive" ~ 2,
    q13  == "Positive" ~ 1,
    q13 == "Neutral" ~ 0,
    q13 == "Negative" ~ -1,
    q13 == "Very Negative" ~ -2,
    q13 == "Unsure/Not familiar" ~ -999)) %>%
  replace_with_na(replace = list(support = -999))%>% 
   replace_with_na(replace = list(q13 = -999))%>%  
  replace_with_na(replace = list(age_group = -999)) %>% 
  filter(support != "NA") %>% 
  filter(age_group != "NA")  %>% # remove incomplete responses
  filter(q13 != "NA") %>% 
  filter(age_group != "5-9") 
  



# remove incomplete responses

```

```{r}
# use spread() to pivot table to wide format

##need to figure out how to make a 3 variable dataframe in R 

ordinal_log_reg_4 <- ordinal_log_reg_4_data %>% 
  filter(support != "NA") %>% 
  filter(age_group != "NA")  %>% # remove incomplete responses
  filter(q13 != "NA") # remove incomplete responses
  
ordinal_log_reg_4_table<- ordinal_log_reg_4 %>% 
  group_by(support) %>% 
  tabyl(support, age_group, q13) 

as.tibble(ordinal_log_reg_4_table)

summary(ordinal_log_reg_4_table)

```

```{r create ordinal logistic model}
#use polr to create a logit model to understand how familiarity influences expansion
m4 <- polr(factor(support) ~q13 + age_group, data=ordinal_log_reg_4, Hess =TRUE)

summary(m4)
```

```{r understand odds ratio}
#interpret odds ratio. Outside parenthesis are important 
(ci4 <- confint(m4))
exp(cbind(coef(m4), t(ci4)))
```

```{r predicted probabilities to understand odds ratio}
newdf4 <- data.frame(q2 =c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10))
(phat4 <- predict(object = m4, newdf4, type = "p"))

#coul is the color palette
coul <- colorRampPalette(brewer.pal(8, "Blues"))(100)

#heatmap
levelplot(phat4, col.regions= coul) 
```








### Demographics 

Comparison of our survey demographics with demographics from Santa Barbara and Ventura Counties. 

##### Age

```{r population demographics}
#values from ACS 2019 combined for SB and V counties
sex_ratio_female_to_male <- 1.01
total_pop <- 1292505 #total population of Ventura and Santa Barbara Counties
total_female <- 650714 #total female population of the two counties
total_male <- 641791  #total male population of the two counties

#load American Community Survey 2019 Data 
ACS_age <- read.csv(here("data", "census", "age_range.csv"))
ACS_sex <- read.csv(here("data", "census", "total_population.csv"))
ACS_age <- ACS_age %>% 
  mutate(proportion = Total/total_pop)

#Age distributions by sex for men
male_dist <- read.csv(here("data", "census", "male_age proportions.csv")) 

#rename colomns
colnames(male_dist) <- c("age_group", "Santa Barbara", "Ventura", "Total")

#add a proprotion column
male_dist <- male_dist%>% 
  mutate(proprotion = Total/total_male) %>% #find proportion 
  #change column names to match grouping
      mutate(age_group = case_when(age_group == "Under 5 years" ~"0-5", 
                           age_group == "5 to 9 years" ~ "5-9",
                           age_group == "10 to 14 years" ~ "10-14",
                           age_group == "15 to 19 years" ~ "15-19",
                           age_group == "20 to 24 years" ~ "20-24",
                           age_group == "25 to 29 years" ~ "25-29",
                           age_group == "30 to 34 years" ~ "30-34",
                           age_group == "35 to 39 years" ~ "34-39",
                           age_group == "40 to 44 years" ~ "40-44",
                           age_group == "45 to 49 years" ~ "45-49",
                           age_group == "50 to 54 years" ~ "50-54",
                           age_group == "55 to 59 years" ~ "55-59",
                           age_group == "60 to 64 years" ~ "60-64",
                           age_group == "65 to 69 years" ~ "65-69",
                           age_group == "70 to 74 years" ~ "70-74",
                           age_group == "75 to 79 years" ~ "75-79",
                           age_group == "80 to 84 years" ~ "80-84",
                           age_group == "85 and over " ~ "85-100"))%>% 
  #filter out people under 18
  filter(!(age_group %in% c("0-5","5-9","10-14","15-19")))

#Age distribution for womn
female_dist <- read.csv(here("data", "census", "female_age_total.csv")) 
colnames(female_dist) <- c("age_group", "Santa Barbara", "Ventura", "Total")
  
female_dist <-female_dist %>% 
    mutate(proprotion = Total/total_female) %>% 
    mutate(age_group = case_when(age_group == "Under 5 years" ~"0-5",
                           age_group == "5 to 9 years" ~ "5-9",
                           age_group == "10 to 14 years" ~"10-14",
                           age_group == "15 to 19 years" ~"15-19",
                           age_group == "20 to 24 years" ~"20-24",
                           age_group == "25 to 29 years" ~"25-29",
                           age_group == "30 to 34 years" ~"30-34",
                           age_group == "35 to 39 years" ~"34-39",
                           age_group == "40 to 44 years" ~"40-44",
                           age_group == "45 to 49 years" ~"45-49",
                           age_group == "50 to 54 years" ~ "50-54",
                           age_group == "55 to 59 years" ~ "55-59",
                           age_group == "60 to 64 years" ~ "60-64",
                           age_group == "65 to 69 years" ~ "65-69",
                           age_group == "70 to 74 years" ~ "70-74",
                           age_group == "75 to 79 years" ~ "75-79",
                           age_group == "80 to 84 years" ~ "80-84",
                           age_group == "85 and over " ~ "85-100")) %>% 
  filter(!(age_group %in% c("0-5","5-9","10-14","15-19")))
```

```{r load and prep sample demographics}

sample_margin <- survey_data_tidy_sbv_filtered
#Create sample margins
sample_margin$q31 <- as.integer(sample_margin$q31)

#create bins for age
labs <- c(paste(seq(0, 95, by = 5), seq(0 + 5 - 1, 100 - 1, by = 5),
                sep = "-"), paste(100, "+", sep = ""))

sample_margin<- sample_margin%>% 
  mutate(age= 2022- q31) 


sample_margin$age_group <- cut(age$age, breaks = c(seq(0, 100, by = 5), Inf), labels = labs, right = FALSE)

```

```{r womens age demographics}
#sample data: Women
female <- age %>% 
  filter(q32 == "Woman") %>% 
  group_by(age_group) %>% 
  summarize(count = n())  

sum(female$count)

```


```{r men age demographics}
#sample data: male age
male <- age %>% 
  filter(q32 == "Man") %>% 
  group_by(age_group) %>% 
  summarize(count = n()) 

sum(male$count)

```

```{r}
#create subset from tidy filtered data
#keep only question 10 and 13
age_perception <- age%>% 
  select(response_id,  q13, age, age_group) %>% 
   filter(age > 18) %>% 
  mutate(q13 = fct_relevel(q13, c(c("Very Negative", "Negative","Neutral","Positive", "Very Positive", "Unsure/Not familiar")))) 

ggplot(age_perception, aes(fill= q13, x = age_group))+
  geom_bar(position = "dodge")+
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#D7191C", "#FDAE61", "#FFFFBF", "#ABD9E9","#2C7BB6", "#999999")) +
  labs(y = "count",
       x = "Perception of Aquaculture",
       title = "Impact of Age on Aquaculture Perceptions (Q13)",
       fill = str_wrap("Perceptions of Aquaculture", width = 15))+
  theme(axis.text.x = element_text(angle= 45),
        legend.text = element_text(size = 8))
  
#put counts into table format
age_perception<- age_perception %>%
  select(age_group, q13) %>% 
  group_by(age_group, q13) %>% 
  melt(age_perception, id.var = c("age_group")) %>% 
  summarize(count = n()) %>% 
  mutate(proportion = (count / sum(count))) 
```


##### Support v. other things
```{r race & ethnicity}
race <- survey_data_tidy_sbv_long_filtered %>% 
  select(response_id, q33, question, answer) %>% 
#combine support metrics
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8" ) %>%
  mutate(question = case_when( 
    question == "q2" ~ "q2",
    question == "q4" ~ "q2",
    question == "q6" ~ "q2",
    question == "q8" ~ "q2")) %>% 
  replace_with_na(replace = list(answer = -999))%>% 
  filter(answer != "NA") %>% 
  mutate(answer = fct_relevel(answer, c("Strongly opposed", "Somewhat opposed", "Neither opposed nor in support", "Somewhat supportive", "Strongly supportive"))) %>% 


#split race into three columns
 separate(q33, c("race_1", "race_2", "race_3"), ",")

#remove blank rows from the answer column
race <- race[!race$answer =="",]

#ploit race and 
ggplot(race, 
       aes(fill= answer, 
           x= answer))+
  geom_bar(position= "dodge")+
  facet_wrap(~race_1)+
  scale_x_discrete(
    labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#D7191C", "#FDAE61", "#FFFFBF", "#ABD9E9","#2C7BB6", "#999999")) +
  labs(y = "count",
       x = "Support for Expanding Aquaculture",
       title = "Race and Support for Expanding Seaweed Aquaculture (Q2)",
       fill = str_wrap("Support/Opposition", width = 15))+
  theme(axis.text.x = element_text(angle= 45),
        legend.text = element_text(size = 8))

#make proportions table by race_1 and answer
race_table <- race %>% 
  group_by(race_1, answer) %>% 
    summarize(count = n()) %>% 
  mutate(proportion = (count / sum(count))) 


#plot proportions table
ggplot(data = race_table, 
       aes(fill = forcats::fct_rev(answer),
           y = proportion,
           x = answer)) +
  geom_bar(position = "stack",
           stat = "identity",
           width = 0.5) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~race_1)+
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#D7191C", "#FDAE61", "#FFFFBF", "#ABD9E9","#2C7BB6", "#999999")) +
  labs(y = "count",
       x = "Support for Expanding Aquaculture",
       title = "Race and Support for Expanding Seaweed Aquaculture (Q2)",
       fill = str_wrap("Support/Opposition", width = 15))+
  theme(axis.text.x = element_text(angle= 45),
        legend.text = element_text(size = 8))
```

```{r relationship to aquaculture (q40)}
aq_rel <- survey_data_tidy_sbv_long_filtered %>% 
  select(response_id, q40, question, answer) %>% 
#combine support metrics
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8" ) %>%
  mutate(question = case_when( 
    question == "q2" ~ "q2",
    question == "q4" ~ "q2",
    question == "q6" ~ "q2",
    question == "q8" ~ "q2")) %>% 
  replace_with_na(replace = list(answer = -999))%>% 
  filter(answer != "NA") %>% 
  mutate(answer = fct_relevel(answer, c("Strongly opposed", "Somewhat opposed", "Neither opposed nor in support", "Somewhat supportive", "Strongly supportive"))) %>%  


#split race into three columns
separate(q40, c("rel_1", "rel_2", "rel_3"), ",")

#remove blank rows from the answer column
aq_rel<- aq_rel[!aq_rel$answer =="",]

#make proportions table by sector_1 and answer
relationship_table <- aq_rel%>% 
  group_by(rel_1, answer) %>% 
    summarize(count = n()) %>% 
  mutate(proportion = (count / sum(count))) 


#plot proportions table
ggplot(data = relationship_table, 
       aes(fill = forcats::fct_rev(answer),
           y = proportion,
           x = rel_1)) +
  geom_bar(position = "stack",
           stat = "identity",
           width = 0.5) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#2C7BB6","#ABD9E9","#FFFFBF", "#FDAE61","#D7191C","#999999"))+
  labs(y = "count",
       x = "Support for Expanding Aquaculture",
       title = "Employment Sector and Support for Expanding Seaweed Aquaculture (Q2)",
       fill = str_wrap("Support/Opposition", width = 15))+
  theme(axis.text.x = element_text(angle= 45),
        legend.text = element_text(size = 8))

```

```{r sector/occupation q39}
sector<- survey_data_tidy_sbv_long_filtered %>% 
  select(response_id, q39, q39_7_text, question, answer) %>% 
#combine support metrics
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8" ) %>%
  mutate(question = case_when( 
    question == "q2" ~ "q2",
    question == "q4" ~ "q2",
    question == "q6" ~ "q2",
    question == "q8" ~ "q2")) %>% 
  replace_with_na(replace = list(answer = -999))%>% 
  filter(answer != "NA") %>% 
  mutate(answer = fct_relevel(answer, c("Strongly opposed", "Somewhat opposed", "Neither opposed nor in support", "Somewhat supportive", "Strongly supportive"))) %>% 
  #categorize common text sector entry
mutate(q39_7_text = case_when(grepl("retired", q39_7_text, ignore.case = TRUE)~ "retired",
                              grepl("disable", q39_7_text, ignore.case = TRUE)~ "disabled",
                              grepl("sales", q39_7_text, ignore.case = TRUE) ~"service industry",
                              grepl("unemploy", q39_7_text, ignore.case = TRUE)~ "unemployed",
                             grepl("not employed", q39_7_text, ignore.case = TRUE)~ "unemployed",
                             grepl("not working", q39_7_text, ignore.case = TRUE)~ "unemployed",
                             grepl("Office Assistant", q39_7_text, ignore.case = TRUE)~ "service industry",
                             grepl("retail", q39_7_text, ignore.case = TRUE)~ "service industry",
                            grepl("real estate", q39_7_text, ignore.case = TRUE)~ "service industry",
                            grepl("journalism", q39_7_text, ignore.case = TRUE)~ "media",
                             grepl("social media", q39_7_text, ignore.case = TRUE)~ "media",
                             grepl("motion pics", q39_7_text, ignore.case = TRUE)~ "media",
                             grepl("writing", q39_7_text, ignore.case = TRUE)~ "media",
                             grepl("utilities", q39_7_text, ignore.case = TRUE)~ "government",
                             grepl("veterin", q39_7_text, ignore.case = TRUE)~ "service industry",
                             grepl("human resources", q39_7_text, ignore.case = TRUE)~ "service industry",
                             grepl("it services", q39_7_text, ignore.case = TRUE)~ "service industry",
       TRUE ~ "other")) %>% 
mutate(q39 = case_when(q39 == "other"~ q39_7_text,
                       TRUE~q39 )) %>% 
  #remove blank occupations
  filter(q39 != "") %>% 
         
#split race into three columns
 separate(q39, c("sector_1", "sector_2", "sector_3"), ",")

#remove blank rows from the answer column
sector<- sector[!sector$answer == "",]


ggplot(sector, 
       aes(fill= answer, 
           x= answer))+
  geom_bar(position= "stack")+
  facet_wrap(~sector_1)+
  scale_x_discrete(
    labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#D7191C", "#FDAE61", "#FFFFBF", "#ABD9E9","#2C7BB6", "#999999")) +
  labs(y = "count",
       x = "Support for Expanding Aquaculture",
       title = "Employment Sector and Support for Expanding Seaweed Aquaculture (Q2)",
       fill = str_wrap("Support/Opposition", width = 15))+
  theme(axis.text.x = element_text(angle= 45),
        legend.text = element_text(size = 8),
        legend.position = "bottom")


#make proportions table by sector_1 and answer
sector_table <- sector%>% 
  group_by(sector_1, answer) %>% 
    summarize(count = n()) %>% 
  mutate(proportion = (count / sum(count))) 

sector_tabyl <- sector %>% 
  tabyl(sector_1, answer) %>% 
  

#plot proportions table
ggplot(data = sector_table, 
       aes(fill = forcats::fct_rev(answer),
           y = proportion,
           x = sector_1)) +
  geom_bar(position = "stack",
           stat = "identity",
           width = 0.5) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
 scale_fill_manual(values =c("#2C7BB6","#ABD9E9","#FFFFBF", "#FDAE61","#D7191C","#999999")) +
  labs(y = "count",
       x = "Support for Expanding Aquaculture",
       title = "Employment Sector and Support for Expanding Seaweed Aquaculture (Q2)",
       fill = str_wrap("Support/Opposition", width = 15))+
  theme(axis.text.x = element_text(angle= 45),
        legend.text = element_text(size = 8))

#chi-square test 
sector_tabyl <- sector %>% 
  tabyl(answer, sector_1) 


```

```{r days by the ocean q15}
ocean_time <- survey_data_tidy_sbv_filtered%>% 
select(response_id, q15, q2, q4, q6, q8) %>% 
#change non-responses to '0 days' because but one non-response corresponds to 'no' response to q14 'do you spend free time by the ocean?'
mutate(q15= case_when(q15 == "" ~ "0 days",
                     TRUE ~ q15)) %>% 
#combine support metrics from multiple columns into one columns
  unite("support", q2:q8, sep ="") %>% 
#filter out non-response for q2-q8
  filter(support != "") %>% 
  mutate(support = fct_relevel(support, c("Strongly opposed", "Somewhat opposed", "Neither opposed nor in support", "Somewhat supportive", "Strongly supportive"))) %>% 
  mutate(q15 = fct_relevel(q15, c("0 days", "1-5 days", "5-10 days", "10-15 days", "15+ days")))

#table
ocean_t_table <- ocean_time%>% 
  group_by(q15, support) %>% 
    summarize(count = n()) %>% 
  mutate(proportion = (count / sum(count))) 


ggplot(data = ocean_t_table, 
       aes(fill = forcats::fct_rev(support),
           y = proportion,
           x = q15)) +
  geom_bar(position = "stack",
           stat = "identity",
           width = 0.5) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels= function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values =c("#2C7BB6","#ABD9E9","#FFFFBF", "#FDAE61","#D7191C","#999999")) +
  labs(y = "count",
       x = "Support for Expanding Aquaculture",
       title = "Monthly Ocean Visitation and Support for Expanding Seaweed Aquaculture (Q2)",
       fill = str_wrap("Support/Opposition", width = 15))+
  theme(axis.text.x = element_text(angle= 45),
        legend.text = element_text(size = 8))
  
summary(ocean_time$q15)


#chi-square test split into five support categories
ocean_t_tabyl <- ocean_time %>% 
  tabyl(q15, support)%>% 
  column_to_rownames(var = "q15")

ocean_t_chi <- chisq.test(ocean_t_tabyl)
ocean_t_chi

```
There appears to be a relationship between monthly ocean visitation and support for expanding seaweed aquaculture. Further analysis will need to be conducted because the total responses for 10-15 days (n=17) and over 15 days a month (24) than for the smaller categories. 

The results do not appear to be statistically significant. However, the small number of responses 

```{r ocean visitation support combined into 3 categories}
#3 support categories
visitation_combo <- ocean_time %>% 
  mutate(support= case_when(
    support == "Strongly supportive" ~ "supportive",
    support == "Somewhat supportive" ~ "supportive",
    support == "Strongly opposed" ~ "opposed",
    support == "Somewhat opposed" ~ "opposed",
    support == "Neither opposed nor in support"~ "Neither opposed nor in support"
  ))

visitation_tabyl <- visitation_combo %>% 
  tabyl(q15, support)%>% 
  column_to_rownames(var = "q15")

visitation_combo_chi <- chisq.test(visitation_tabyl)
visitation_combo_chi
visitation_fishers <- fisher.test(visitation_tabyl, workspace = 2e7)
visitation_fishers
```

Upon further analysis however, there does not seem to be a statistically significant relationship between the amount of days per month people spend by the ocean and their support for expanding aquaculture when tested with the Fishers and chi-square test. 















