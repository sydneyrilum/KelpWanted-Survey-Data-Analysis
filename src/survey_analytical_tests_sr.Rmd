---
title: "Survey Analytical Tests"
author: "Sydney Rilum"
date: "1/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(janitor)
library(broom)
library(kableExtra)
library(data.table)  # advanced pivot_table tools
library(naniar)      # replace NA tools
library(zipcodeR)    # for zipcode assignment by county
#library(raster)      # for mapping raster layers
#library(dplyr)       # needed ONLY if working on a windows computer
```

## Data Set-up & Cleaning 

```{r}
# Read in combined survey data
survey_data <- read.csv(here("data","survey_data","combined_survey_responses.csv")) 

survey_data_clean <- survey_data %>%
  clean_names() %>% 
  slice(-1) # remove first row of df
```

```{r}
## Filter for Santa Barbara & Ventura County Zipcodes 
# Q37 - Zipcode Data

# Create a dataframe containing only zipcodes from Ventura and Santa Barbara Counties
## Not run:
download_zip_data() # uses zipcodeR data 
## End(Not run)

ventura_co_zip_full <-
  search_county("ventura", "CA") 

ventura_zipcodes<- 
  ventura_co_zip_full[,c("zipcode", "county", "lat", "lng")]

sb_co_zip_full <- 
 search_county("Santa Barbara", "CA")

sb_zipcodes<- 
  sb_co_zip_full[,c("zipcode", "county", "lat", "lng")]

# combine SB & Ventura zipcode data frames
sb_ventura_co_zip <- 
  rbind(ventura_zipcodes, sb_zipcodes)
```

```{r}
# select survey responses from Ventura and Santa Barbara Counties ONLY
survey_data_sbv <- merge(survey_data_clean, sb_ventura_co_zip, 
                         by.x = "q37", by.y = "zipcode")

## Convert dataframe to tidydata format (Reshaping the data)
# convert data frame into a data table
survey_data_sbv <- as.data.table(survey_data_sbv)

# use melt() from `datatable` package (advanced version of pivot_longer()) to reshape data from wide to long format
survey_data_sbv_tidy <- survey_data_sbv %>% 
  melt(id.vars = c("response_id", "response_type", "finished"), 
       variable.name = "question", 
       value.name = "answer")
```

```{r}
## Filter Survey Response Type

# Response Types Key:
# 0 = speeders (time removal)
# 1 = completes (approved by our team)
# 2 = removed by our team for replacement (flagged for not answering ranking questions, but otherwise fine)
# 3 = response collected via our own outreach (QRcode/email/social media)

# (Note: Qualtrics Paid Responses = 0,1,2)

# remove speeders responses (response type: 0) from survey dataframes
survey_data_sbv_tidy_filtered <- survey_data_sbv_tidy %>% 
  filter(response_type != 0)
```


## Chi-Square Test

A chi-square test for independence will be used to compare proportions/count data collected in the survey and determine whether or not there is an association between word choice/terminology and a residentsâ€™ support for kelp aquaculture.

```{r}
# Create a table with both counts & proportions
support_counts <- survey_data_sbv_tidy_filtered %>% 
  select(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") %>% 
  mutate(number = case_when( 
    answer == "Very Negative" ~ 1,
    answer == "Negative" ~ 2,
    answer == "Neutral" ~ 3,
    answer == "Positive" ~ 4,
    answer == "Very Positive" ~ 5,
    answer == "Unsure/Not familiar" ~ 6)) %>%
  mutate_all(na_if,"")

support_counts_table <- support_counts %>% 
  tabyl(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") %>% 
  select(-NA_)

```

```{r}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `question` column entries into stored rownames)
support_ct <- support_counts_table %>% 
  column_to_rownames(var = "question")

# Chi-square test for independence: Is there an association between support for aquaculture and word choice?
support_x2 <- chisq.test(support_ct)
support_x2

# Get the chi-square test results to call outputs in-line
support_tidy <- tidy(support_x2)
```

There is not a significant association between word choice and whether a Santa Barbara or Ventura County resident is supportive of kelp aquaculture ($\chi$^2^(`r support_tidy$parameter`) = `r round(support_tidy$statistic,2)`, *p* = `r format(support_tidy$p.value, scientific = TRUE, digits = 3)`). Therefore, we accept the null hypothesis that there is no association between word choice and whether a Santa Barbara or Ventura County resident is supportive of kelp aquaculture. 

AND thus we can group answers from Q2,4,6,8 together for further analyses.

```{r}
### NOT NEEDED FOR CHI-SQUARE

# Add proportions to counts table
support_counts_prop_table <- support_counts_table %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() #%>% 
#  adorn_ns()

# Finalized counts and proportions table
#support_counts_prop_table %>% 
  #kable(col.names = c("Political Affiliation", "Yes", "No", "Unsure")) %>% 
  #kable_styling(bootstrap_options = "bordered")
```















