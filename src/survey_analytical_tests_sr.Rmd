---
title: "Survey - Analytical Tests"
author: "Sydney Rilum"
date: "1/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(janitor)
library(broom)
library(kableExtra)
library(data.table)  # advanced pivot_table tools
library(naniar)      # replace NA tools
library(zipcodeR)    # for zipcode assignment by county
#library(raster)      # for mapping raster layers
#library(dplyr)       # needed ONLY if working on a windows computer
```

## Data Set-up & Cleaning 

```{r}
# Read in combined survey data
survey_data <- read.csv(here("data","survey_data","combined_survey_responses.csv")) 

survey_data_clean <- survey_data %>%
  clean_names() %>% 
  slice(-1) # remove first row of df
```

```{r}
## Filter for Santa Barbara & Ventura County Zipcodes 
# Q37 - Zipcode Data

# Create a dataframe containing only zipcodes from Ventura and Santa Barbara Counties
## Not run:
download_zip_data() # uses zipcodeR data 
## End(Not run)

ventura_co_zip_full <-
  search_county("ventura", "CA") 

ventura_zipcodes<- 
  ventura_co_zip_full[,c("zipcode", "county", "lat", "lng")]

sb_co_zip_full <- 
 search_county("Santa Barbara", "CA")

sb_zipcodes<- 
  sb_co_zip_full[,c("zipcode", "county", "lat", "lng")]

# combine SB & Ventura zipcode data frames
sb_ventura_co_zip <- 
  rbind(ventura_zipcodes, sb_zipcodes)
```

```{r}
# select survey responses from Ventura County residents ONLY
survey_data_v <- merge(survey_data_clean, ventura_zipcodes, 
                         by.x = "q37", by.y = "zipcode")

# select survey responses from Santa Barbara County residents ONLY
survey_data_sb <- merge(survey_data_clean, sb_zipcodes, 
                         by.x = "q37", by.y = "zipcode")

# select survey responses from Ventura AND Santa Barbara County residents
survey_data_sbv <- merge(survey_data_clean, sb_ventura_co_zip, 
                         by.x = "q37", by.y = "zipcode")
```


```{r}
## Convert dataframe to tidydata format (Reshaping the data)

# convert data frame into a data table for ventura county zipcodes
survey_data_v <- as.data.table(survey_data_v)

# reshape data from wide to long format
survey_data_v_tidy <- survey_data_v %>% 
  melt(id.vars = c("response_id", "response_type", "finished"), 
       variable.name = "question", 
       value.name = "answer")


# repeat for sb county zipcodes
survey_data_sb <- as.data.table(survey_data_sb)

# reshape data from wide to long format
survey_data_sb_tidy <- survey_data_sb %>% 
  melt(id.vars = c("response_id", "response_type", "finished"), 
       variable.name = "question", 
       value.name = "answer")


# repeat for combined ventura AND sb county zipcodes
survey_data_sbv <- as.data.table(survey_data_sbv)

# reshape data from wide to long format
survey_data_sbv_tidy <- survey_data_sbv %>% 
  melt(id.vars = c("response_id", "response_type", "finished"), 
       variable.name = "question", 
       value.name = "answer")

```



```{r}
## Filter Survey Response Type

# Response Types Key:
# 0 = speeders (time removal)
# 1 = completes (approved by our team)
# 2 = removed by our team for replacement (flagged for not answering ranking questions, but otherwise fine)
# 3 = response collected via our own outreach (QRcode/email/social media)

# (Note: Qualtrics Paid Responses = 0,1,2)

# remove speeders responses (response type: 0) from survey dataframes - for ventura county zipcodes
survey_data_v_tidy_filtered <- survey_data_v_tidy %>% 
  filter(response_type != 0)

# repeat for sb county zipcodes
survey_data_sb_tidy_filtered <- survey_data_sb_tidy %>% 
  filter(response_type != 0)

# repeat for ventura AND sb county combined zipcodes
survey_data_sbv_tidy_filtered <- survey_data_sbv_tidy %>% 
  filter(response_type != 0)
```


# Chi-Square Test Assumptions & Hypothesis Testing

A chi-square test for independence will be used to compare proportions/count data collected in the survey and determine whether or not there is an association between word choice/terminology and a residents’ support for kelp aquaculture.

*Assumptions for Chi-Square Test:*

A Chi-Square test of independence is used to determine whether or not there is a significant association between two categorical variables.
This test makes four assumptions:

*Assumption 1:* Both variables are categorical.

It’s assumed that both variables are categorical. That is, both variables take on values that are names or labels.

Our variables: word choice/terminology (either kelp farming, seaweed farming, kelp aquaculture, or seaweed aquaculture) and support for kelp aquaculture (five likert scale categories from strongly opposed to strongly supportive)

*Assumption 2:* All observations are independent.

It’s assumed that every observation in the dataset is independent. That is, the value of one observation in the dataset does not affect the value of any other observation.

*Assumption 3:* Cells in the contingency table are mutually exclusive.

It’s assumed that individuals can only belong to one cell in the contingency table. That is, cells in the table are mutually exclusive – an individual cannot belong to more than one cell.

*Assumption 4:* Expected value of cells should be 5 or greater in at least 80% of cells.

It’s assumed that the expected value of cells in the contingency table should be 5 or greater in at least 80% of cells and that no cell should have an expected value less than 1.



# 1. & 2. Wording Experiment: 

*Question:* Does word choice/terminology influence residents' support for kelp aquaculture?

*Hypothesis:*  Yes, people will be more supportive of ‘kelp farming’ than of 'kelp aquaculture', 'seaweed aquaculture', and 'seaweed farming' because of its associations with an important native Californian species and since farming is a more familiar term.

*Statistical Test:* Chi-square test of Q2, Q4, Q6, Q8


## Chi-Square Test for Ventura County residents ONLY
```{r}
# Create a table with both counts & proportions
support_counts_v <- survey_data_v_tidy_filtered %>% 
  select(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") %>% 
  mutate(number = case_when( 
    answer == "Strongly opposed" ~ 1,
    answer == "Somewhat opposed" ~ 2,
    answer == "Neither opposed nor in support" ~ 3,
    answer == "Somewhat supportive" ~ 4,
    answer == "Strongly supportive" ~ 5)) %>%
  mutate_all(na_if,"") %>% 
  drop_na()

support_counts_v_table <- support_counts_v %>% 
  tabyl(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") 
```

```{r}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `question` column entries into stored rownames)
support_v_ct <- support_counts_v_table %>% 
  column_to_rownames(var = "question")

# Chi-square test for independence: Is there an association between support for aquaculture and word choice?
support_v_x2 <- chisq.test(support_v_ct)
support_v_x2

# Get the chi-square test results to call outputs in-line
support_v_tidy <- tidy(support_v_x2)
```

The p-value of the test is 0.3301. Since this p-value is not less than .05, we do not have sufficient evidence to say that there is an association between word choice/terminology and support for kelp aquaculture, for Ventura County residents.

## Fisher exact test for Ventura County residents ONLY

The data violate the assumptions of the chi-square test (80% of the expected values >5). The fisher exact test will be used instead. 

```{r}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `q10` column entries into stored rownames)

fisher_support_v <- fisher.test(support_v_ct)
fisher_support_v <- tidy(fisher_support_v)
```



## Chi-Square Test for SB County residents ONLY
```{r}
# Create a table with both counts & proportions
support_counts_sb <- survey_data_sb_tidy_filtered %>% 
  select(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") %>% 
  mutate(number = case_when( 
    answer == "Strongly opposed" ~ 1,
    answer == "Somewhat opposed" ~ 2,
    answer == "Neither opposed nor in support" ~ 3,
    answer == "Somewhat supportive" ~ 4,
    answer == "Strongly supportive" ~ 5)) %>%
  mutate_all(na_if,"") %>% 
  drop_na()

support_counts_sb_table <- support_counts_sb %>% 
  tabyl(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") 
```

```{r}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `question` column entries into stored rownames)
support_sb_ct <- support_counts_sb_table %>% 
  column_to_rownames(var = "question")

# Chi-square test for independence: Is there an association between support for aquaculture and word choice?
support_sb_x2 <- chisq.test(support_sb_ct)
support_sb_x2

# Get the chi-square test results to call outputs in-line
support_sb_tidy <- tidy(support_sb_x2)
```

The p-value of the test is 0.4502. Since this p-value is not less than .05, we do not have sufficient evidence to say that there is an association between word choice/terminology and support for kelp aquaculture, for Santa Barbara County residents.

## Fisher exact test for SB County residents ONLY

The data violate the assumptions of the chi-square test (80% of the expected values >5). The fisher exact test will be used instead. 

```{r}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `q10` column entries into stored rownames)

fisher_support_sb <- fisher.test(support_sb_ct)
fisher_support_sb <- tidy(fisher_support_sb)
```




Since the chi-square tests revealed no association between word choice/terminology and support for kelp aquaculture for both Ventura and Santa Barbara County residents individually, we can now combine the datasets and perform a chi-square test once more for further analysis.

## Chi-Square Test for SB & Ventura County residents combined
```{r}
# Create a table with both counts & proportions
support_counts <- survey_data_sbv_tidy_filtered %>% 
  select(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") %>% 
  mutate(number = case_when( 
    answer == "Strongly opposed" ~ 1,
    answer == "Somewhat opposed" ~ 2,
    answer == "Neither opposed nor in support" ~ 3,
    answer == "Somewhat supportive" ~ 4,
    answer == "Strongly supportive" ~ 5)) %>%
  mutate_all(na_if,"") %>% 
  drop_na()

support_counts_table <- support_counts %>% 
  tabyl(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") 

```

```{r}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `question` column entries into stored rownames)
support_ct <- support_counts_table %>% 
  column_to_rownames(var = "question")

# Chi-square test for independence: Is there an association between support for aquaculture and word choice?
support_x2 <- chisq.test(support_ct)
support_x2

# Get the chi-square test results to call outputs in-line
support_tidy <- tidy(support_x2)
```

The p-value of the test is 0.3543. Since this p-value is not less than .05, we do not have sufficient evidence to say that there is an association between word choice/terminology and support for kelp aquaculture.

There is not a significant association between word choice and whether a Santa Barbara and Ventura County residents are supportive of kelp aquaculture ($\chi$^2^(`r support_tidy$parameter`) = `r round(support_tidy$statistic,2)`, *p* = `r format(support_tidy$p.value, scientific = TRUE, digits = 3)`). Therefore, we accept the null hypothesis that there is no association between word choice and whether a Santa Barbara or Ventura County resident is supportive of kelp aquaculture. 


## Fisher exact test for SB & Ventura County residents combined

The data violate the assumptions of the chi-square test (80% of the expected values >5). The fisher exact test will be used instead. 

```{r}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `q10` column entries into stored rownames)

fisher_support_sbv <- fisher.test(support_ct) # , workspace = 2e8)
fisher_support_sbv <- tidy(fisher_support_sbv)
```






#### USE THIS CODE BELOW!!! 

## Chi-Square Test for SB & Ventura County residents combined (WITH COMBINING ANSWER CHOICES)
```{r}
# Create a table with both counts & proportions
support_counts_combined <- survey_data_sbv_tidy_filtered %>% 
  select(question, answer) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") %>% 
  mutate(number = case_when( 
    answer == "Strongly opposed" ~ 1,
    answer == "Somewhat opposed" ~ 1,
    answer == "Neither opposed nor in support" ~ 2,
    answer == "Somewhat supportive" ~ 3,
    answer == "Strongly supportive" ~ 3)) %>%
  mutate_all(na_if,"") %>% 
  drop_na()

support_counts_combined_table <- support_counts_combined %>%  
  tabyl(question, number) %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8")   

```

```{r}
# Use `column_to_rownames` to convert counts table to a contingency table (makes `question` column entries into stored rownames)
support_combined_ct <- support_counts_combined_table %>% 
  column_to_rownames(var = "question")

# Chi-square test for independence: Is there an association between support for aquaculture and word choice?
support_combined_x2 <- chisq.test(support_combined_ct)
support_combined_x2

# Get the chi-square test results to call outputs in-line
support_combined_tidy <- tidy(support_combined_x2)
```

The p-value of the test is 0.1637. Since this p-value is not less than .05, we do not have sufficient evidence to say that there is a significant association between word choice/terminology and support for kelp aquaculture.

X2 (6, N = 386) = 9.2, p > .05

There is not a significant association between word choice and whether a Santa Barbara and Ventura County residents are supportive of kelp aquaculture ($\chi$^2^(`r support_tidy$parameter`) = `r round(support_tidy$statistic,2)`, *p* = `r format(support_tidy$p.value, scientific = TRUE, digits = 3)`). Therefore, we accept the null hypothesis that there is no association between word choice and whether a Santa Barbara or Ventura County resident is supportive of kelp aquaculture. 



AND thus we can now group answers from Q2,4,6,8 together for further analyses, assuming that this combined data set reflects respondents support or opposition to the synonymous terms of kelp/seaweed aquaculture and kelp/seaweed farming.


```{r}
# Combine Q2,4,6,8

# Are you supportive of or opposed to expanding ______ off the California coast?
# q2 - seaweed farming
# q4 - kelp farming
# q6 - seaweed aquaculture
# q8 - kelp aquaculture

combined_support_answers <- survey_data_tidy_sbv_long_filtered %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8") %>%
  mutate(question = case_when( 
    question == "q2" ~ "q2",
    question == "q4" ~ "q2",
    question == "q6" ~ "q2",
    question == "q8" ~ "q2")) %>% 
  filter(answer != "") %>% 
  drop_na() %>% 
  group_by(question, answer) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  group_by(question) %>% 
  mutate(proportion = (count / sum(count)))

# Specify categorical order of questions and answers
combined_support_answers$answer <- factor(combined_support_answers$answer, levels = c("Strongly opposed", 
                                                                                        "Somewhat opposed", 
                                                                                        "Neither opposed nor in support",
                                                                                        "Somewhat supportive",
                                                                                        "Strongly supportive"))

# percent stacked barchart
ggplot(data = combined_support_answers, 
       aes(fill = forcats::fct_rev(answer),
           x = proportion,
           y = question)) +
  geom_bar(position = "stack",
           stat = "identity") +
  scale_x_continuous(labels = scales::percent) +
  scale_fill_brewer(type = "div",
                    palette = "RdYlGn",
                    direction = -1) +
  labs(x = "",
       y = "",
       title = "Are you supportive of or opposed to expanding \nseaweed aquaculture off the California coast?") +
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = "right") 

```



# 3. Perception: 

*Question:* Does perception of aquaculture change when specifying seaweed aquaculture? 

*Hypothesis:* 

*Statistical Test:* t-test of Q12 vs. Q13




# 4. Relationship Between Perception and Support: 

*Question:* Is support related to more positive perceptions of seaweed aquaculture?

*Hypothesis:* Yes, supporters will have more positive perceptions of seaweed aquaculture.

*Assumptions:* 
- Since Q2,4, 6, 8 are not significantly different, then questions/answers can thus be combined.
- Remove "don't know" answer choice counts

*Statistical Test:* Ordinal logistic regression of perception combined support values (Q2,4,6,8) vs. perception value from Q13 (seaweed aquaculture)


dependent variable = support (Q2)
independent variable = perception (Q13)


```{r}
# create data frame with Q2 and Q13

ordinal_log_reg_data <- survey_data_tidy_sbv_long_filtered %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8" |
         question == "q13") %>%
  mutate(question = case_when( 
    question == "q2" ~ "q2",
    question == "q4" ~ "q2",
    question == "q6" ~ "q2",
    question == "q8" ~ "q2",
    question == "q13" ~ "q13")) %>% 
  mutate(answer = case_when( 
    answer == "Strongly opposed" ~ -2,
    answer == "Somewhat opposed" ~ -1,
    answer == "Neither opposed nor in support" ~ 0,
    answer == "Somewhat supportive" ~ 1,
    answer == "Strongly supportive" ~ 2,
    answer == "Very Negative" ~ -2,
    answer == "Negative" ~ -1,
    answer == "Neutral" ~ 0,
    answer == "Positive" ~ 1,
    answer == "Very Positive" ~ 2,
    answer == "Unsure/Not familiar" ~ -999)) %>%
  replace_with_na(replace = list(answer = -999))%>%  # remove "unsure" count data
  filter(answer != "NA") # remove incomplete responses

```

```{r}
# use spread() to pivot table to wide format
ordinal_log_reg <- ordinal_log_reg_data %>% 
  select(response_id, question, answer) %>% 
  spread(question, answer) %>% 
  filter(q13 != "NA")  %>% # remove incomplete responses
  filter(q2 != "NA") # remove incomplete responses
  
ordinal_log_reg_table<- ordinal_log_reg %>% 
  tabyl(q2, q13) %>% 
  column_to_rownames(var = "q2")
```



# 5. Knowledge: 

*Questions:* Are residents familiar with kelp aquaculture? 

*Hypothesis:* The majority of the public have not been exposed to the idea of seaweed aquaculture.

*Statistical Tests:* Chi-square test Q10 & Mann-Whitney U on Q16, Q17 



#6. Relationship Between Knowledge and Support: 

*Question:* Does familiarity with aquaculture influence support for expansion? 

*Hypothesis:* Those who are familiar with aquaculture will have more polarized opinions. Those less familiar will have more positive views of kelp aquaculture. 

*Statistical Test:* Ordinal logistic regression of familiarity (Q10, Q16, and/or Q17) to predict support (combined result of support: Q2,4,6,8)

```{r}
# create data frame with Q2 and Q10

ordinal_log_reg_2_data <- survey_data_tidy_sbv_long_filtered %>% 
  filter(question == "q2" | 
         question == "q4" |
         question == "q6" |
         question == "q8" |
         question == "q10") %>%
  mutate(question = case_when( 
    question == "q2" ~ "q2",
    question == "q4" ~ "q2",
    question == "q6" ~ "q2",
    question == "q8" ~ "q2",
    question == "q10" ~ "q10")) %>% 
  mutate(answer = case_when( 
    answer == "Strongly opposed" ~ -2,
    answer == "Somewhat opposed" ~ -1,
    answer == "Neither opposed nor in support" ~ 0,
    answer == "Somewhat supportive" ~ 1,
    answer == "Strongly supportive" ~ 2,
    answer == "Very familiar" ~ 1,
    answer == "Basic understanding" ~ 2,
    answer == "Heard of it, but don't know details" ~ 3,
    answer == "Never heard of it" ~ 4)) %>%
  filter(answer != "NA") # remove incomplete responses

```

```{r}
# use spread() to pivot table to wide format
ordinal_log_reg_2 <- ordinal_log_reg_2_data %>% 
  select(response_id, question, answer) %>% 
  spread(question, answer) %>% 
  filter(q10 != "NA")  %>% # remove incomplete responses
  filter(q2 != "NA") # remove incomplete responses
  
ordinal_log_reg_2_table<- ordinal_log_reg_2 %>% 
  tabyl(q2, q10) %>% 
  column_to_rownames(var = "q2")
```




